{% extends "base.html" %}

{% block title %}Админ-панель{% endblock %}

{% block head %}
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .header h1 {
        margin: 0;
    }
    .logout-btn {
        padding: 8px 16px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .logout-btn:hover {
        background-color: #c82333;
    }
    .section {
        margin-bottom: 30px;
    }
    .section h2 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
    }
    .stat-card h3 {
        margin: 0 0 10px 0;
        color: #6c757d;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }
    th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    tr:hover {
        background-color: #f8f9fa;
    }
    .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
    }
    .status-active {
        background-color: #28a745;
        color: white;
    }
    .status-degraded {
        background-color: #ffc107;
        color: black;
    }
    .status-cooldown {
        background-color: #dc3545;
        color: white;
    }
    .actions {
        display: flex;
        gap: 8px;
    }
    .btn {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-edit {
        background-color: #007bff;
        color: white;
    }
    .btn-delete {
        background-color: #dc3545;
        color: white;
    }
    .account-management {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .account-form {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

    .account-form h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #444;
    }

    .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }

    .btn-add {
        background-color: #28a745;
        color: white;
        width: 100%;
        margin-top: 10px;
    }

    .btn-add:hover {
        background-color: #218838;
    }

    .users-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    .user-card {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
    .user-card h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #333;
    }
    .user-info {
        margin-bottom: 10px;
    }
    .user-info p {
        margin: 5px 0;
    }
    .api-key-container {
        margin: 15px 0;
    }

    .api-key {
        display: flex;
        align-items: center;
        background-color: #f8f9fa;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
        margin-top: 5px;
    }

    .api-key input {
        font-family: monospace;
        font-size: 14px;
        color: #333;
    }

    .api-key .copy-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
        font-size: 12px;
    }

    .api-key .copy-btn:hover {
        background-color: #218838;
    }

    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    .modal-content {
        position: relative;
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
    }
    .close {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 28px;
        cursor: pointer;
    }
    .error {
        color: #dc3545;
        margin-top: 10px;
        text-align: center;
    }
    .success {
        color: #28a745;
        margin-top: 10px;
        text-align: center;
    }
    .register-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        border: 1px solid #ddd;
    }
    .register-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .register-buttons {
        grid-column: 1 / -1;
        display: flex;
        gap: 10px;
    }
    .accounts-info {
        margin-top: 15px;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }

    .accounts-info h4 {
        color: #333;
        margin: 10px 0;
        font-size: 16px;
    }

    .accounts-info ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .accounts-info li {
        background: #f8f9fa;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
        margin-top: 5px;
    }

    .no-users {
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        color: #666;
    }

    .telegram-accounts, .vk-accounts {
        margin-bottom: 20px;
    }

    .account-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .account-details {
        font-size: 14px;
        color: #666;
        margin-bottom: 10px;
    }

    .account-details p {
        margin: 5px 0;
    }

    .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: bold;
    }

    .status-active {
        background-color: #28a745;
        color: white;
    }

    .status-degraded {
        background-color: #ffc107;
        color: black;
    }

    .status-cooldown {
        background-color: #dc3545;
        color: white;
    }

    .account-phone, .account-token {
        font-weight: bold;
        color: #333;
    }

    .modal-content .api-key {
        display: flex;
        align-items: center;
        background-color: #f8f9fa;
        padding: 10px;
        margin: 15px 0;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .modal-content .api-key span {
        font-family: monospace;
        font-size: 16px;
        flex-grow: 1;
        word-break: break-all;
    }

    .modal-content .copy-btn {
        margin-left: 10px;
        background-color: #28a745;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
    }

    .modal-content .btn-primary {
        margin-top: 15px;
        width: 100%;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Админ-панель</h1>
        <button class="logout-btn" onclick="logout()">Выйти</button>
    </div>

    <div class="section">
        <h2>Управление пользователями</h2>
        <div class="user-management">
            <div class="user-form">
                <h3>Добавить пользователя</h3>
                <form id="addUserForm">
                    <div class="form-group">
                        <label for="username">Имя пользователя:</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Пароль:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn">Добавить пользователя</button>
                </form>
            </div>
            <div id="usersList" class="users-list">
                <!-- Список пользователей будет добавлен динамически -->
            </div>
        </div>
    </div>

    <!-- Модальные окна -->
    <div id="telegramModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Добавить аккаунт Telegram</h2>
            <form id="addTelegramForm">
                <div class="form-group">
                    <label for="telegramApiId">API ID:</label>
                    <input type="text" id="telegramApiId" name="api_id" required>
                </div>
                <div class="form-group">
                    <label for="telegramApiHash">API Hash:</label>
                    <input type="text" id="telegramApiHash" name="api_hash" required>
                </div>
                <div class="form-group">
                    <label for="telegramPhone">Номер телефона:</label>
                    <input type="text" id="telegramPhone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="telegramProxy">Прокси (опционально):</label>
                    <input type="text" id="telegramProxy" name="proxy">
                </div>
                <button type="submit" class="btn">Добавить</button>
            </form>
        </div>
    </div>

    <div id="vkModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Добавить аккаунт VK</h2>
            <form id="addVkForm">
                <div class="form-group">
                    <label for="vkToken">Токен VK:</label>
                    <input type="text" id="vkToken" name="token" required>
                </div>
                <div class="form-group">
                    <label for="vkProxy">Прокси (опционально):</label>
                    <input type="text" id="vkProxy" name="proxy">
                </div>
                <button type="submit" class="btn">Добавить</button>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;
    let adminKey = localStorage.getItem('adminKey');

    // Проверяем наличие админ-ключа при загрузке
    if (!adminKey) {
        window.location.href = `${BASE_URL}/login`;
    }

    // Загружаем данные при загрузке страницы
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Проверяем валидность админ-ключа
            const validateResponse = await fetch(`${BASE_URL}/admin/validate`, {
                method: 'POST',
                headers: {
                    'X-Admin-Key': adminKey
                }
            });

            if (!validateResponse.ok) {
                localStorage.removeItem('adminKey');
                window.location.href = `${BASE_URL}/login`;
                return;
            }

            // Загружаем данные
            await Promise.all([
                loadSystemStats(),
                loadUsers()
            ]);
        } catch (error) {
            console.error('Ошибка инициализации:', error);
            localStorage.removeItem('adminKey');
            window.location.href = `${BASE_URL}/login`;
        }
    });

    // Функция для регистрации пользователя
    async function registerUser() {
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;
        const resultDiv = document.getElementById('registerResult');

        if (!username || !password) {
            resultDiv.innerHTML = '<div class="error">Заполните все поля</div>';
            return;
        }

        try {
            const response = await fetch(`${BASE_URL}/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();
            console.log('Registration response:', data); // Добавим для отладки

            if (response.ok && data.api_key) {
                resultDiv.innerHTML = '<div class="success">Пользователь успешно зарегистрирован</div>';
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerPassword').value = '';
                showFullApiKey(data.api_key);
                await loadUsers();
            } else {
                resultDiv.innerHTML = `<div class="error">Ошибка: ${data.detail || 'Неизвестная ошибка'}</div>`;
            }
        } catch (error) {
            console.error('Ошибка регистрации:', error);
            resultDiv.innerHTML = '<div class="error">Ошибка при регистрации пользователя</div>';
        }
    }

    // Функция для добавления Telegram аккаунта
    async function addTelegramAccount() {
        const modal = document.getElementById('telegramModal');
        const apiId = modal.querySelector('#telegramApiId').value;
        const apiHash = modal.querySelector('#telegramApiHash').value;
        const phone = modal.querySelector('#telegramPhone').value;
        const proxy = modal.querySelector('#telegramProxy').value;
        const sessionFile = modal.querySelector('#telegramSession').files[0];
        const resultDiv = modal.querySelector('#telegramResult');

        console.log('Adding Telegram account:', {
            apiId,
            apiHash,
            phone,
            proxy,
            hasSessionFile: !!sessionFile,
            currentUser
        });

        if (!apiId || !apiHash || !phone) {
            resultDiv.innerHTML = '<div class="error">Заполните обязательные поля</div>';
            return;
        }

        const formData = new FormData();
        formData.append('api_id', apiId);
        formData.append('api_hash', apiHash);
        formData.append('phone', phone);
        if (proxy) formData.append('proxy', proxy);
        if (sessionFile) formData.append('session_file', sessionFile);

        try {
            const response = await fetch(`${BASE_URL}/admin/users/${currentUser}/telegram`, {
                method: 'POST',
                headers: {
                    'X-Admin-Key': adminKey
                },
                body: formData
            });

            const data = await response.json();
            console.log('Server response:', data);

            if (response.ok) {
                resultDiv.innerHTML = '<div class="success">Аккаунт успешно добавлен</div>';
                closeTelegramModal();
                await loadUsers();
            } else {
                resultDiv.innerHTML = `<div class="error">Ошибка: ${data.detail || 'Неизвестная ошибка'}</div>`;
            }
        } catch (error) {
            console.error('Error adding Telegram account:', error);
            resultDiv.innerHTML = `<div class="error">Ошибка: ${error.message}</div>`;
        }
    }

    // Функция для добавления VK аккаунта
    async function addVkAccount() {
        const token = document.getElementById('vkToken').value;
        const proxy = document.getElementById('vkProxy').value;

        if (!token) {
            document.getElementById('vkResult').innerHTML = 
                '<div class="error">Введите токен VK</div>';
            return;
        }

        try {
            const response = await fetch(`${BASE_URL}/admin/users/${currentUser}/vk`, {
                method: 'POST',
                headers: {
                    'X-Admin-Key': adminKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    token: token,
                    proxy: proxy
                })
            });

            if (response.ok) {
                document.getElementById('vkResult').innerHTML = 
                    '<div class="success">Аккаунт успешно добавлен</div>';
                closeVkModal();
                await loadUsers();
            } else {
                const error = await response.json();
                document.getElementById('vkResult').innerHTML = 
                    `<div class="error">Ошибка: ${error.detail}</div>`;
            }
        } catch (error) {
            document.getElementById('vkResult').innerHTML = 
                `<div class="error">Ошибка: ${error.message}</div>`;
        }
    }

    // Функция для выхода
    function logout() {
        localStorage.removeItem('adminKey');
        window.location.href = `${BASE_URL}/login`;
    }

    // Функция для загрузки системной статистики
    async function loadSystemStats() {
        try {
            const response = await fetch(`${BASE_URL}/admin/stats`, {
                headers: {
                    'X-Admin-Key': adminKey
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    localStorage.removeItem('adminKey');
                    window.location.href = `${BASE_URL}/login`;
                    return;
                }
                throw new Error('Ошибка загрузки статистики');
            }

            const stats = await response.json();
            const statsHtml = `
                <div class="stat-card">
                    <h3>Всего пользователей</h3>
                    <div class="stat-value">${stats.total_users}</div>
                </div>
                <div class="stat-card">
                    <h3>Активных пользователей</h3>
                    <div class="stat-value">${stats.active_users}</div>
                </div>
                <div class="stat-card">
                    <h3>Telegram аккаунтов</h3>
                    <div class="stat-value">${stats.telegram_accounts}</div>
                </div>
                <div class="stat-card">
                    <h3>VK аккаунтов</h3>
                    <div class="stat-value">${stats.vk_accounts}</div>
                </div>
            `;
            document.getElementById('systemStats').innerHTML = statsHtml;
        } catch (error) {
            console.error('Error loading system stats:', error);
            document.getElementById('systemStats').innerHTML = `
                <div class="stat-card">
                    <h3>Ошибка</h3>
                    <div class="stat-value">Не удалось загрузить статистику</div>
                </div>
            `;
        }
    }

    // Функция для загрузки списка пользователей
    async function loadUsers() {
        try {
            const response = await fetch(`${BASE_URL}/admin/users`, {
                headers: {
                    'X-Admin-Key': adminKey
                }
            });

            if (response.ok) {
                const users = await response.json();
                displayUsers(users);
            } else {
                console.error('Ошибка загрузки пользователей');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    function getStatusText(status) {
        const statusMap = {
            'active': 'Активен',
            'degraded': 'Ухудшен',
            'cooldown': 'Ожидание'
        };
        return statusMap[status] || status;
    }

    function displayUsers(users) {
        const usersList = document.getElementById('usersList');
        if (!users || users.length === 0) {
            usersList.innerHTML = '<p>Нет зарегистрированных пользователей</p>';
            return;
        }

        usersList.innerHTML = users.map(user => `
            <div class="user-card">
                <h3>Пользователь: ${user.username}</h3>
                <p>API ключ: ${user.api_key}</p>
                <p>Создан: ${new Date(user.created_at).toLocaleString()}</p>
                <p>Последнее использование: ${user.last_used ? new Date(user.last_used).toLocaleString() : 'Нет'}</p>
                
                <div class="accounts-info">
                    <h4>Telegram аккаунты (${user.telegram_accounts.length})</h4>
                    <ul>
                        ${user.telegram_accounts.map(acc => `
                            <li>
                                ${acc.phone} - ${getStatusText(acc.status)}
                                ${acc.proxy ? `<br>Прокси: ${acc.proxy}` : ''}
                                <button onclick="deleteTelegramAccount('${user.api_key}', '${acc.id}')" class="delete-btn">Удалить</button>
                            </li>
                        `).join('')}
                    </ul>
                    <button onclick="showTelegramModal('${user.api_key}')" class="add-btn">Добавить Telegram</button>
                </div>

                <div class="accounts-info">
                    <h4>VK аккаунты (${user.vk_accounts.length})</h4>
                    <ul>
                        ${user.vk_accounts.map(acc => `
                            <li>
                                Токен: ${acc.token.substring(0, 10)}... - ${getStatusText(acc.status)}
                                ${acc.proxy ? `<br>Прокси: ${acc.proxy}` : ''}
                                <button onclick="deleteVkAccount('${user.api_key}', '${acc.id}')" class="delete-btn">Удалить</button>
                            </li>
                        `).join('')}
                    </ul>
                    <button onclick="showVkModal('${user.api_key}')" class="add-btn">Добавить VK</button>
                </div>

                <button onclick="deleteUser('${user.api_key}')" class="delete-btn">Удалить пользователя</button>
            </div>
        `).join('');
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            alert('API ключ скопирован в буфер обмена');
        }).catch(err => {
            console.error('Ошибка при копировании:', err);
            alert('Не удалось скопировать API ключ');
        });
    }

    // Функция для удаления пользователя
    async function deleteUser(apiKey) {
        if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            return;
        }

        try {
            const response = await fetch(`${BASE_URL}/admin/users/${apiKey}`, {
                method: 'DELETE',
                headers: {
                    'X-Admin-Key': adminKey
                }
            });

            if (!response.ok) {
                throw new Error('Ошибка удаления пользователя');
            }

            // Перезагружаем данные
            await loadSystemStats();
            await loadUsers();
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Ошибка при удалении пользователя');
        }
    }

    // Функция для редактирования пользователя
    function editUser(apiKey) {
        // TODO: Реализовать редактирование пользователя
        alert('Редактирование пользователя будет добавлено позже');
    }

    // Функция для выбора пользователя
    let selectedApiKey = null;
    function selectUser(apiKey) {
        selectedApiKey = apiKey;
        // Подсвечиваем выбранного пользователя
        document.querySelectorAll('#usersList .user-card').forEach(card => {
            if (card.dataset.apiKey === apiKey) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    }

    function showApiKey(apiKey) {
        document.getElementById('apiKeyText').textContent = apiKey;
        document.getElementById('apiKeyModal').style.display = 'block';
    }

    function closeApiKeyModal() {
        document.getElementById('apiKeyModal').style.display = 'none';
    }

    function copyApiKey() {
        const apiKey = document.getElementById('apiKeyText').textContent;
        if (apiKey && apiKey !== 'Ключ не найден') {
            navigator.clipboard.writeText(apiKey).then(() => {
                alert('API ключ скопирован в буфер обмена');
            }).catch(err => {
                console.error('Ошибка при копировании:', err);
                alert('Не удалось скопировать API ключ');
            });
        } else {
            alert('Нет доступного ключа для копирования');
        }
    }

    // Функции для работы с модальными окнами
    function showTelegramModal(apiKey) {
        currentUser = apiKey;
        const modal = document.getElementById('telegramModal');
        const title = modal.querySelector('h2');
        title.textContent = `Добавить аккаунт Telegram для пользователя ${apiKey}`;
        modal.style.display = 'block';
    }

    function showVkModal(apiKey) {
        currentUser = apiKey;
        const modal = document.getElementById('vkModal');
        const title = modal.querySelector('h2');
        title.textContent = `Добавить аккаунт VK для пользователя ${apiKey}`;
        modal.style.display = 'block';
    }

    // Закрытие модальных окон
    document.querySelectorAll('.close').forEach(closeBtn => {
        closeBtn.onclick = function() {
            this.closest('.modal').style.display = 'none';
            currentUser = null;
        }
    });

    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
            currentUser = null;
        }
    }

    // Обработка форм
    document.getElementById('addTelegramForm').onsubmit = async function(e) {
        e.preventDefault();
        if (!currentUser) {
            alert('Пользователь не выбран');
            return;
        }

        const formData = new FormData(this);
        const data = {
            api_id: formData.get('api_id'),
            api_hash: formData.get('api_hash'),
            phone: formData.get('phone'),
            proxy: formData.get('proxy') || null
        };

        try {
            const response = await fetch(`/admin/users/${currentUser}/telegram`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            alert('Аккаунт Telegram успешно добавлен');
            document.getElementById('telegramModal').style.display = 'none';
            loadUsers(); // Перезагружаем список пользователей
        } catch (error) {
            console.error('Error:', error);
            alert('Ошибка при добавлении аккаунта Telegram');
        }
    };

    document.getElementById('addVkForm').onsubmit = async function(e) {
        e.preventDefault();
        if (!currentUser) {
            alert('Пользователь не выбран');
            return;
        }

        const formData = new FormData(this);
        const data = {
            token: formData.get('token'),
            proxy: formData.get('proxy') || null
        };

        try {
            const response = await fetch(`/admin/users/${currentUser}/vk`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                },
                body: JSON.stringify(data)
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();
            alert('Аккаунт VK успешно добавлен');
            document.getElementById('vkModal').style.display = 'none';
            loadUsers(); // Перезагружаем список пользователей
        } catch (error) {
            console.error('Error:', error);
            alert('Ошибка при добавлении аккаунта VK');
        }
    };

    function showFullApiKey(apiKey) {
        const modal = document.getElementById('apiKeyModal');
        const apiKeyText = document.getElementById('apiKeyText');
        apiKeyText.textContent = apiKey || 'Ключ не найден';
        console.log('Showing API key:', apiKey); // Добавим для отладки
        modal.style.display = 'block';
    }
</script>
{% endblock %} 