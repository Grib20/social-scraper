{% extends "base.html" %}

{% block title %}Админ-панель{% endblock %}

{% block head %}
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #f5f5f5;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    .header h1 {
        margin: 0;
    }
    .logout-btn {
        padding: 8px 16px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .logout-btn:hover {
        background-color: #c82333;
    }
    .section {
        margin-bottom: 30px;
    }
    .section h2 {
        color: #333;
        border-bottom: 2px solid #007bff;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    .stat-card {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        text-align: center;
    }
    .stat-card h3 {
        margin: 0 0 10px 0;
        color: #6c757d;
    }
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #007bff;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }
    th, td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #dee2e6;
    }
    th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    tr:hover {
        background-color: #f8f9fa;
    }
    .status {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
    }
    .status-active {
        background-color: #28a745;
        color: white;
    }
    .status-degraded {
        background-color: #ffc107;
        color: black;
    }
    .status-cooldown {
        background-color: #dc3545;
        color: white;
    }
    .actions {
        display: flex;
        gap: 8px;
    }
    .btn {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
    }
    .btn-edit {
        background-color: #007bff;
        color: white;
    }
    .btn-delete {
        background-color: #dc3545;
        color: white;
    }
    .account-management {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .account-form {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
    }

    .account-form h3 {
        margin-top: 0;
        margin-bottom: 15px;
        color: #333;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #444;
    }

    .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-sizing: border-box;
    }

    .btn-add {
        background-color: #28a745;
        color: white;
        width: 100%;
        margin-top: 10px;
    }

    .btn-add:hover {
        background-color: #218838;
    }

    .users-list {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    .user-card {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
    .user-card h3 {
        margin-top: 0;
        margin-bottom: 10px;
        color: #333;
    }
    .user-info {
        margin-bottom: 10px;
    }
    .user-info p {
        margin: 5px 0;
    }
    .api-key {
        background-color: #e9ecef;
        padding: 8px;
        border-radius: 4px;
        font-family: monospace;
        margin: 10px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .copy-btn {
        background-color: #28a745;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
    }
    .copy-btn:hover {
        background-color: #218838;
    }
    .modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
    }
    .modal-content {
        position: relative;
        background-color: white;
        margin: 15% auto;
        padding: 20px;
        width: 80%;
        max-width: 500px;
        border-radius: 8px;
    }
    .close {
        position: absolute;
        right: 20px;
        top: 10px;
        font-size: 28px;
        cursor: pointer;
    }
    .error {
        color: #dc3545;
        margin-top: 10px;
        text-align: center;
    }
    .success {
        color: #28a745;
        margin-top: 10px;
        text-align: center;
    }
    .register-section {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        border: 1px solid #ddd;
    }
    .register-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
    }
    .register-buttons {
        grid-column: 1 / -1;
        display: flex;
        gap: 10px;
    }
    .accounts-info {
        margin-top: 15px;
        border-top: 1px solid #eee;
        padding-top: 15px;
    }

    .accounts-info h4 {
        color: #333;
        margin: 10px 0;
        font-size: 16px;
    }

    .accounts-info ul {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .accounts-info li {
        background: #f8f9fa;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .btn-sm {
        padding: 4px 8px;
        font-size: 12px;
        margin-top: 5px;
    }

    .no-users {
        text-align: center;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
        color: #666;
    }

    .telegram-accounts, .vk-accounts {
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="header">
        <h1>Админ-панель</h1>
        <button class="logout-btn" onclick="logout()">Выйти</button>
    </div>

    <div class="section register-section">
        <h2>Регистрация пользователя</h2>
        <div class="register-form">
            <div class="form-group">
                <label>Имя пользователя:</label>
                <input type="text" id="registerUsername" required>
            </div>
            <div class="form-group">
                <label>Пароль:</label>
                <input type="password" id="registerPassword" required>
            </div>
            <div class="register-buttons">
                <button class="btn btn-primary" onclick="registerUser()">Зарегистрировать</button>
            </div>
        </div>
        <div id="registerResult"></div>
    </div>

    <div class="section">
        <h2>Системная статистика</h2>
        <div id="systemStats" class="stats-grid">
            <div class="stat-card">
                <h3>Загрузка...</h3>
                <div class="stat-value">-</div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Управление аккаунтами</h2>
        <div class="account-management">
            <div class="account-form">
                <h3>Добавить Telegram аккаунт</h3>
                <div class="form-group">
                    <label>API ID:</label>
                    <input type="text" id="telegramApiId" placeholder="Введите API ID">
                </div>
                <div class="form-group">
                    <label>API Hash:</label>
                    <input type="text" id="telegramApiHash" placeholder="Введите API Hash">
                </div>
                <div class="form-group">
                    <label>Номер телефона:</label>
                    <input type="text" id="telegramPhone" required>
                </div>
                <div class="form-group">
                    <label>Прокси (опционально):</label>
                    <input type="text" id="telegramProxy" placeholder="socks5://user:pass@host:port">
                </div>
                <div class="form-group">
                    <label>Файл сессии (опционально):</label>
                    <input type="file" id="telegramSession" accept=".session">
                </div>
                <button class="btn btn-add" onclick="addTelegramAccount()">Добавить Telegram аккаунт</button>
            </div>

            <div class="account-form">
                <h3>Добавить VK аккаунт</h3>
                <div class="form-group">
                    <label>Access Token:</label>
                    <input type="text" id="vkToken" placeholder="Введите Access Token">
                </div>
                <div class="form-group">
                    <label>Прокси (опционально):</label>
                    <input type="text" id="vkProxy" placeholder="socks5://user:pass@host:port">
                </div>
                <button class="btn btn-add" onclick="addVkAccount()">Добавить VK аккаунт</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>Пользователи</h2>
        <div id="usersList" class="users-list"></div>
    </div>
</div>

<!-- Модальное окно для отображения API ключа -->
<div id="apiKeyModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeApiKeyModal()">&times;</span>
        <h2>API ключ пользователя</h2>
        <div class="api-key">
            <span id="apiKeyText"></span>
            <button class="copy-btn" onclick="copyApiKey()">Копировать</button>
        </div>
        <button class="btn btn-primary" onclick="closeApiKeyModal()">Закрыть</button>
    </div>
</div>

<!-- Модальное окно для добавления Telegram аккаунта -->
<div id="telegramModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeTelegramModal()">&times;</span>
        <h2>Добавить Telegram аккаунт</h2>
        <div class="form-group">
            <label>API ID:</label>
            <input type="text" id="telegramApiId" required>
        </div>
        <div class="form-group">
            <label>API Hash:</label>
            <input type="text" id="telegramApiHash" required>
        </div>
        <div class="form-group">
            <label>Номер телефона:</label>
            <input type="text" id="telegramPhone" required>
        </div>
        <div class="form-group">
            <label>Прокси (опционально):</label>
            <input type="text" id="telegramProxy" placeholder="socks5://user:pass@host:port">
        </div>
        <div class="form-group">
            <label>Файл сессии (опционально):</label>
            <input type="file" id="telegramSession" accept=".session">
        </div>
        <button class="btn btn-primary" onclick="addTelegramAccount()">Добавить</button>
        <div id="telegramResult"></div>
    </div>
</div>

<!-- Модальное окно для добавления VK аккаунта -->
<div id="vkModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeVkModal()">&times;</span>
        <h2>Добавить VK аккаунт</h2>
        <div class="form-group">
            <label>Access Token:</label>
            <input type="text" id="vkToken" required>
        </div>
        <div class="form-group">
            <label>Прокси (опционально):</label>
            <input type="text" id="vkProxy" placeholder="socks5://user:pass@host:port">
        </div>
        <button class="btn btn-primary" onclick="addVkAccount()">Добавить</button>
        <div id="vkResult"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentUser = null;

    // Проверяем наличие админ-ключа при загрузке
    const adminKey = localStorage.getItem('adminKey');
    if (!adminKey) {
        window.location.href = `${BASE_URL}/login`;
    }

    // Загружаем данные при загрузке страницы
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Проверяем валидность админ-ключа
            const validateResponse = await fetch(`${BASE_URL}/admin/validate`, {
                method: 'POST',
                headers: {
                    'X-Admin-Key': adminKey
                }
            });

            if (!validateResponse.ok) {
                localStorage.removeItem('adminKey');
                window.location.href = `${BASE_URL}/login`;
                return;
            }

            // Загружаем данные
            await Promise.all([
                loadSystemStats(),
                loadUsers()
            ]);
        } catch (error) {
            console.error('Ошибка инициализации:', error);
            localStorage.removeItem('adminKey');
            window.location.href = `${BASE_URL}/login`;
        }
    });

    // Функция для регистрации пользователя
    async function registerUser() {
        const username = document.getElementById('registerUsername').value;
        const password = document.getElementById('registerPassword').value;
        const resultDiv = document.getElementById('registerResult');

        if (!username || !password) {
            resultDiv.innerHTML = '<div class="error">Заполните все поля</div>';
            return;
        }

        try {
            const response = await fetch(`${BASE_URL}/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Admin-Key': adminKey
                },
                body: JSON.stringify({ username, password })
            });

            const data = await response.json();

            if (response.ok) {
                resultDiv.innerHTML = '<div class="success">Пользователь успешно зарегистрирован</div>';
                document.getElementById('registerUsername').value = '';
                document.getElementById('registerPassword').value = '';
                showApiKey(data.api_key);
                await loadUsers();
            } else {
                resultDiv.innerHTML = `<div class="error">Ошибка: ${data.detail || 'Неизвестная ошибка'}</div>`;
            }
        } catch (error) {
            console.error('Ошибка регистрации:', error);
            resultDiv.innerHTML = '<div class="error">Ошибка при регистрации пользователя</div>';
        }
    }

    // Функция для добавления Telegram аккаунта
    async function addTelegramAccount() {
        const apiId = document.getElementById('telegramApiId').value;
        const apiHash = document.getElementById('telegramApiHash').value;
        const phone = document.getElementById('telegramPhone').value;
        const proxy = document.getElementById('telegramProxy').value;
        const sessionFile = document.getElementById('telegramSession').files[0];

        if (!apiId || !apiHash || !phone) {
            document.getElementById('telegramResult').innerHTML = 
                '<div class="error">Заполните обязательные поля</div>';
            return;
        }

        const formData = new FormData();
        formData.append('api_id', apiId);
        formData.append('api_hash', apiHash);
        formData.append('phone', phone);
        if (proxy) formData.append('proxy', proxy);
        if (sessionFile) formData.append('session_file', sessionFile);

        try {
            const response = await fetch(`${BASE_URL}/admin/users/${currentUser}/telegram`, {
                method: 'POST',
                headers: {
                    'X-Admin-Key': adminKey
                },
                body: formData
            });

            if (response.ok) {
                document.getElementById('telegramResult').innerHTML = 
                    '<div class="success">Аккаунт успешно добавлен</div>';
                closeTelegramModal();
                await loadUsers();
            } else {
                const error = await response.json();
                document.getElementById('telegramResult').innerHTML = 
                    `<div class="error">Ошибка: ${error.detail}</div>`;
            }
        } catch (error) {
            document.getElementById('telegramResult').innerHTML = 
                `<div class="error">Ошибка: ${error.message}</div>`;
        }
    }

    // Функция для добавления VK аккаунта
    async function addVkAccount() {
        const token = document.getElementById('vkToken').value;
        const proxy = document.getElementById('vkProxy').value;

        if (!token) {
            document.getElementById('vkResult').innerHTML = 
                '<div class="error">Введите токен VK</div>';
            return;
        }

        try {
            const response = await fetch(`${BASE_URL}/admin/users/${currentUser}/vk`, {
                method: 'POST',
                headers: {
                    'X-Admin-Key': adminKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    token: token,
                    proxy: proxy
                })
            });

            if (response.ok) {
                document.getElementById('vkResult').innerHTML = 
                    '<div class="success">Аккаунт успешно добавлен</div>';
                closeVkModal();
                await loadUsers();
            } else {
                const error = await response.json();
                document.getElementById('vkResult').innerHTML = 
                    `<div class="error">Ошибка: ${error.detail}</div>`;
            }
        } catch (error) {
            document.getElementById('vkResult').innerHTML = 
                `<div class="error">Ошибка: ${error.message}</div>`;
        }
    }

    // Функция для выхода
    function logout() {
        localStorage.removeItem('adminKey');
        window.location.href = `${BASE_URL}/login`;
    }

    // Функция для загрузки системной статистики
    async function loadSystemStats() {
        try {
            const response = await fetch(`${BASE_URL}/admin/stats`, {
                headers: {
                    'X-Admin-Key': adminKey
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    localStorage.removeItem('adminKey');
                    window.location.href = `${BASE_URL}/login`;
                    return;
                }
                throw new Error('Ошибка загрузки статистики');
            }

            const stats = await response.json();
            const statsHtml = `
                <div class="stat-card">
                    <h3>Всего пользователей</h3>
                    <div class="stat-value">${stats.total_users}</div>
                </div>
                <div class="stat-card">
                    <h3>Активных пользователей</h3>
                    <div class="stat-value">${stats.active_users}</div>
                </div>
                <div class="stat-card">
                    <h3>Telegram аккаунтов</h3>
                    <div class="stat-value">${stats.telegram_accounts}</div>
                </div>
                <div class="stat-card">
                    <h3>VK аккаунтов</h3>
                    <div class="stat-value">${stats.vk_accounts}</div>
                </div>
            `;
            document.getElementById('systemStats').innerHTML = statsHtml;
        } catch (error) {
            console.error('Error loading system stats:', error);
            document.getElementById('systemStats').innerHTML = `
                <div class="stat-card">
                    <h3>Ошибка</h3>
                    <div class="stat-value">Не удалось загрузить статистику</div>
                </div>
            `;
        }
    }

    // Функция для загрузки списка пользователей
    async function loadUsers() {
        try {
            const response = await fetch(`${BASE_URL}/admin/users`, {
                headers: {
                    'X-Admin-Key': adminKey
                }
            });

            if (response.ok) {
                const users = await response.json();
                displayUsers(users);
            } else {
                console.error('Ошибка загрузки пользователей');
            }
        } catch (error) {
            console.error('Ошибка:', error);
        }
    }

    function displayUsers(users) {
        const container = document.getElementById('usersList');
        if (!users || users.length === 0) {
            container.innerHTML = '<div class="no-users">Нет зарегистрированных пользователей</div>';
            return;
        }

        container.innerHTML = users.map(user => `
            <div class="user-card">
                <h3>${user.username || 'Неизвестно'}</h3>
                <div class="user-info">
                    <p><strong>API ключ:</strong> 
                        <span class="api-key">
                            ${user.api_key.substring(0, 8)}...
                            <button class="copy-btn" onclick="showApiKey('${user.api_key}')">Показать</button>
                        </span>
                    </p>
                    <p><strong>Создан:</strong> ${user.created_at ? new Date(user.created_at).toLocaleString() : 'Не указано'}</p>
                    <p><strong>Последнее использование:</strong> ${user.last_used ? new Date(user.last_used).toLocaleString() : 'Нет'}</p>
                    <p><strong>VK токен:</strong> ${user.vk_token ? 'Установлен' : 'Не установлен'}</p>
                    <div class="accounts-info">
                        <div class="telegram-accounts">
                            <h4>Telegram аккаунты (${user.telegram_accounts.length}):</h4>
                            ${user.telegram_accounts.length > 0 ? `
                                <ul>
                                    ${user.telegram_accounts.map(acc => `
                                        <li>
                                            Телефон: ${acc.phone}<br>
                                            Статус: ${acc.status || 'Активен'}<br>
                                            ${acc.proxy ? `Прокси: ${acc.proxy}<br>` : ''}
                                            <button class="btn btn-danger btn-sm" onclick="deleteTelegramAccount('${user.api_key}', '${acc.id}')">Удалить</button>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : '<p>Нет аккаунтов</p>'}
                        </div>
                        <div class="vk-accounts">
                            <h4>VK аккаунты (${user.vk_accounts.length}):</h4>
                            ${user.vk_accounts.length > 0 ? `
                                <ul>
                                    ${user.vk_accounts.map(acc => `
                                        <li>
                                            Токен: ${acc.token.substring(0, 8)}...<br>
                                            Статус: ${acc.status || 'Активен'}<br>
                                            ${acc.proxy ? `Прокси: ${acc.proxy}<br>` : ''}
                                            <button class="btn btn-danger btn-sm" onclick="deleteVkAccount('${user.api_key}', '${acc.id}')">Удалить</button>
                                        </li>
                                    `).join('')}
                                </ul>
                            ` : '<p>Нет аккаунтов</p>'}
                        </div>
                    </div>
                </div>
                <div class="user-actions">
                    <button class="btn btn-primary" onclick="showTelegramModal('${user.api_key}')">Добавить Telegram</button>
                    <button class="btn btn-primary" onclick="showVkModal('${user.api_key}')">Добавить VK</button>
                    <button class="btn btn-danger" onclick="deleteUser('${user.api_key}')">Удалить пользователя</button>
                </div>
            </div>
        `).join('');
    }

    // Вспомогательная функция для определения класса статуса
    function getStatusClass(status) {
        switch (status) {
            case 'active':
                return 'status-active';
            case 'degraded':
                return 'status-degraded';
            case 'cooldown':
                return 'status-cooldown';
            default:
                return '';
        }
    }

    // Функция для удаления пользователя
    async function deleteUser(apiKey) {
        if (!confirm('Вы уверены, что хотите удалить этого пользователя?')) {
            return;
        }

        try {
            const response = await fetch(`${BASE_URL}/admin/users/${apiKey}`, {
                method: 'DELETE',
                headers: {
                    'X-Admin-Key': adminKey
                }
            });

            if (!response.ok) {
                throw new Error('Ошибка удаления пользователя');
            }

            // Перезагружаем данные
            await loadSystemStats();
            await loadUsers();
        } catch (error) {
            console.error('Error deleting user:', error);
            alert('Ошибка при удалении пользователя');
        }
    }

    // Функция для редактирования пользователя
    function editUser(apiKey) {
        // TODO: Реализовать редактирование пользователя
        alert('Редактирование пользователя будет добавлено позже');
    }

    // Функция для выбора пользователя
    let selectedApiKey = null;
    function selectUser(apiKey) {
        selectedApiKey = apiKey;
        // Подсвечиваем выбранного пользователя
        document.querySelectorAll('#usersList .user-card').forEach(card => {
            if (card.dataset.apiKey === apiKey) {
                card.classList.add('selected');
            } else {
                card.classList.remove('selected');
            }
        });
    }

    function showApiKey(apiKey) {
        document.getElementById('apiKeyText').textContent = apiKey;
        document.getElementById('apiKeyModal').style.display = 'block';
    }

    function closeApiKeyModal() {
        document.getElementById('apiKeyModal').style.display = 'none';
    }

    function copyApiKey() {
        const apiKey = document.getElementById('apiKeyText').textContent;
        navigator.clipboard.writeText(apiKey).then(() => {
            alert('API ключ скопирован в буфер обмена');
        });
    }

    function showTelegramModal(apiKey) {
        currentUser = apiKey;
        document.getElementById('telegramModal').style.display = 'block';
    }

    function closeTelegramModal() {
        document.getElementById('telegramModal').style.display = 'none';
        currentUser = null;
    }

    function showVkModal(apiKey) {
        currentUser = apiKey;
        document.getElementById('vkModal').style.display = 'block';
    }

    function closeVkModal() {
        document.getElementById('vkModal').style.display = 'none';
        currentUser = null;
    }
</script>
{% endblock %} 